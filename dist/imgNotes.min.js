/*! jQuery imgNotes - v0.7.6 - 2015-06-13
* https://github.com/waynegm/imgNotes
* Copyright (c) 2015 Wayne Mogg; Licensed MIT */
!function(a){a.widget("wgm.imgNotes",{options:{zoom:1,zoomStep:.1,zoomable:!0,canEdit:!1,vAll:"middle",hAll:"middle",onAdd:function(){return this.options.vAll="bottom",this.options.hAll="middle",a(document.createElement("span")).addClass("marker black").html(this.noteCount)},onEdit:function(b,c){var d=a(c);return a("#NoteDialog").remove(),a('<div id="NoteDialog"></div>').dialog({title:"Note Editor",resizable:!1,modal:!0,height:"300",width:"450",position:{my:"left bottom",at:"right top",of:c},buttons:{Save:function(){var b=a("textarea",this).val();d.data("note",b),a(this).dialog("close")},Delete:function(){d.trigger("remove"),a(this).dialog("close")},Cancel:function(){a(this).dialog("close")}},open:function(){a(this).css("overflow","hidden");var b=a('<textarea id="txt" style="height:100%; width:100%;">');a(this).html(b),b.val(d.data("note"))}})},onShow:function(b,c){var d=a(c);return a("#NoteDialog").remove(),a('<div id="NoteDialog"></div>').dialog({modal:!1,resizable:!1,height:300,width:250,position:{my:"left bottom",at:"right top",of:c},buttons:{Close:function(){a(this).dialog("close")}},open:function(){a(this).html(d.data("note")),a(this).closest(".ui-dialog").find(".ui-dialog-titlebar:first").hide()},close:function(){a(this).dialog("destroy")}})},onUpdateMarker:function(b){var c=a(b),d=a(this.img),e=d.imgViewer("imgToView",c.data("relx"),c.data("rely"));e&&c.css({left:e.x-c.data("xOffset"),top:e.y-c.data("yOffset"),position:"absolute"})},onUpdate:function(){var b=this;a.each(this.notes,function(){b.options.onUpdateMarker.call(b,this)})}},_create:function(){var b=this;this.element.is("img")||a.error("imgNotes plugin can only be applied to img elements"),b.notes=[],b.noteCount=0,b.img=b.element[0];var c=a(b.img);c.imgViewer({onClick:function(a,c){if(b.options.canEdit){a.preventDefault();var d=c.cursorToImg(a.pageX,a.pageY);if(d){var e=b.addNote(d.x,d.y);b._trigger("onEdit",a,e)}}},onUpdate:function(a,c){b.options.zoom=c.options.zoom,b.options.onUpdate.call(b)},zoom:b.options.zoom,zoomStep:b.options.zoomStep,zoomable:b.options.zoomable}),c.imgViewer("update")},destroy:function(){this.clear(),a(this.img).imgViewer("destroy"),a.Widget.prototype.destroy.call(this)},_setOption:function(b,c){switch(b){case"vAll":switch(c){case"top":break;case"bottom":break;default:c="middle"}break;case"hAll":switch(c){case"left":break;case"right":break;default:c="middle"}}var d=a.ui.version.split(".");switch(d[0]>1||d[1]>8?this._super(b,c):a.Widget.prototype._setOption.apply(this,arguments),b){case"zoom":a(this.img).imgViewer("option","zoom",c);break;case"zoomStep":a(this.img).imgViewer("option","zoomStep",c);break;case"zoomable":a(this.img).imgViewer("option","zoomable",c)}},panTo:function(b,c){return a(this.img).imgViewer("panTo",b,c)},addNote:function(b,c,d){var e=this;this.noteCount++;var f=this.options.onAdd.call(this),g=a(f);switch(a(this.img).imgViewer("addElem",f),g.data("relx",b).data("rely",c).data("note",d),this.options.vAll){case"top":g.data("yOffset",0);break;case"bottom":g.data("yOffset",g.height());break;default:g.data("yOffset",Math.round(g.height()/2))}switch(this.options.hAll){case"left":g.data("xOffset",0);break;case"right":g.data("xOffset",g.width());break;default:g.data("xOffset",Math.round(g.width()/2))}return g.click(function(a){a.preventDefault(),e.options.canEdit?e._trigger("onEdit",a,f):e._trigger("onShow",a,f)}),g.on("remove",function(){e._delete(f)}),this.notes.push(f),a(this.img).imgViewer("update"),f},count:function(){return this.noteCount},_delete:function(b){this.notes=this.notes.filter(function(a){return a!==b}),a(b).off(),a(b).remove(),a(this.img).imgViewer("update")},clear:function(){for(var a=this,b=a.notes.length,c=0;b>c;c++){var d=a.notes[c];d.off(),d.remove()}a.notes=[],a.noteCount=0},"import":function(b){var c=this;a.each(b,function(){c.addNote(this.x,this.y,this.note)}),a(this.img).imgViewer("update")},"export":function(){var b=[];return a.each(this.notes,function(){var c=a(this);b.push({x:c.data("relx"),y:c.data("rely"),note:c.data("note")})}),b}})}(jQuery);