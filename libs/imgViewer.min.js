/*! jQuery imgViewer - v0.7.2 - 2014-09-12
* https://github.com/waynegm/imgViewer
* Copyright (c) 2014 Wayne Mogg; Licensed MIT */
(function(t,e){var o,n="drag",i={distance:40};e.track(n,{touchstart:function(t,e,i){o=!1,e[n]={finger:i.point.length,start:i,deltaX:0,deltaY:0}},touchmove:function(r,s,a){var p=t.extend(i,r.data);s[n].finger=a.point.length>s[n].finger?a.point.length:s[n].finger;var h=e.calc.getDistance(s.start.point[0],a.point[0]);Math.abs(1-h)>p.distance&&(o||(t(r.target).trigger(t.Event("dragstart",s[n])),o=!0),s[n].deltaX=a.point[0].x-s.start.point[0].x,s[n].deltaY=a.point[0].y-s.start.point[0].y,t(r.target).trigger(t.Event("drag",s[n])))},touchend:function(r,s,a){if(o){o=!1;var p=e.calc.getDistance(s.start.point[0],a.point[0]);p>i.distance&&(s[n].deltaX=a.point[0].x-s.start.point[0].x,s[n].deltaY=a.point[0].y-s.start.point[0].y,t(r.target).trigger(t.Event("dragend",s[n])))}}})})(jQuery,jQuery.toe,this),function(t){t.widget("wgm.imgViewer",{options:{zoomStep:.1,zoom:1,zoomable:!0,onClick:null,onUpdate:null},_create:function(){function e(){r.render||(r.render=!0,n())}function o(){r.render=!1}function n(){r.render&&(window.requestAnimationFrame(n),r.update())}function i(t){if(r.options.zoomable){t.preventDefault();var e=t.deltaY;r.options.zoom-=e*r.options.zoomStep,r.update()}}var r=this;this.element.is("img")||t.error("imgviewer plugin can only be applied to img elements"),r.img=r.element[0];var s=t(r.img);r.zimg=t("<img/>",{src:r.img.src}).appendTo("body").wrap("<div class='viewport'/>");var a=t(r.zimg);r.view=t(r.zimg).parent();var p=t(r.view);r.vCenter={},r.dragging=!1,r.ready=!1,s.one("load",function(){r.ready=!0;var t=s.width(),e=s.height(),o=s.offset();r.offsetPadding={top:parseInt(s.css("padding-top"),10),left:parseInt(s.css("padding-left"),10),right:parseInt(s.css("padding-right"),10),bottom:parseInt(s.css("padding-bottom"),10)},r.offsetBorder={x:Math.round((s.outerWidth()-s.innerWidth())/2),y:Math.round((s.outerHeight()-s.innerHeight())/2)};var n=o.top+r.offsetBorder.y+r.offsetPadding.top,i=o.left+r.offsetBorder.x+r.offsetPadding.left;p.css({position:"absolute",overflow:"hidden",top:n+"px",left:i+"px",width:t+"px",height:e+"px"}),a.css({position:"relative",top:"0px",left:"0px",width:t+"px",height:e+"px","-webkit-tap-highlight-color":"transparent"}),r.vCenter={x:t/2,y:e/2},r.update()}).each(function(){this.complete&&t(this).load()}),r.render=!1,a.on("mousewheel",i),window.navigator.msPointerEnabled?(a.on("click",function(t){t.preventDefault(),r.dragging||r._trigger("onClick",t,r)}),a.on("mousedown",function(n){function i(e){setTimeout(function(){r.dragging=!1},0),e.preventDefault(),o(),a.off("mousemove"),a.off("mouseup"),t(document).off("mouseup")}if(r.options.zoomable){t(document).one("mouseup",i),a.one("mouseup",i),n.preventDefault(),e();var s=n;a.on("mousemove",function(t){t.preventDefault(),r.dragging=!0,r.vCenter.x=r.vCenter.x-(t.pageX-s.pageX)/r.options.zoom,r.vCenter.y=r.vCenter.y-(t.pageY-s.pageY)/r.options.zoom,s=t})}})):(a.on("touchstart touchmove touchend",function(t){t.preventDefault()}),a.on("transformstart",function(t){r.options.zoomable&&(t.preventDefault(),r.pinchzoom=r.options.zoom,e())}),a.on("transform",function(t){r.options.zoomable&&(t.preventDefault(),r.options.zoom=r.pinchzoom*t.scale)}),a.on("transformend",function(t){r.options.zoomable&&(t.preventDefault(),r.options.zoom=r.pinchzoom*t.scale,o(),r.update())}),a.on("dragstart",function(t){r.options.zoomable&&(t.preventDefault(),r.dragging=!0,r.dragXorg=r.vCenter.x,r.dragYorg=r.vCenter.y,e())}),a.on("drag",function(t){r.options.zoomable&&(t.preventDefault(),r.vCenter.x=r.dragXorg-t.deltaX/r.options.zoom,r.vCenter.y=r.dragYorg-t.deltaY/r.options.zoom)}),a.on("dragend",function(t){r.options.zoomable&&(t.preventDefault(),r.dragging=!1,r.vCenter.x=r.dragXorg-t.deltaX/r.options.zoom,r.vCenter.y=r.dragYorg-t.deltaY/r.options.zoom,o(),r.update())}),void 0!==t.mobile?a.on("vclick",function(t){t.preventDefault(),r.dragging||r._trigger("onClick",t,r)}):a.on("tap click",function(t){t.preventDefault(),r.dragging||r._trigger("onClick",t,r)}),a.on("mousedown",function(n){function i(e){setTimeout(function(){r.dragging=!1},0),e.preventDefault(),o(),a.off("mousemove"),a.off("mouseup"),t(document).off("mouseup")}if(r.options.zoomable){n.preventDefault(),e();var s=n;a.on("mousemove",function(t){t.preventDefault(),r.dragging=!0,r.vCenter.x=r.vCenter.x-(t.pageX-s.pageX)/r.options.zoom,r.vCenter.y=r.vCenter.y-(t.pageY-s.pageY)/r.options.zoom,s=t}),t(document).one("mouseup",i),a.one("mouseup",i)}})),t(window).resize(function(){r.ready&&(r.vCenter.x*=s.width()/p.width(),r.vCenter.y*=s.height()/p.height(),r.update())})},destroy:function(){var e=t(this.zimg);e.unbind("click"),t(window).unbind("resize"),e.remove(),t(this.view).remove(),t.Widget.prototype.destroy.call(this)},_setOption:function(e,o){switch(e){case"zoom":if(1>parseFloat(o)||isNaN(parseFloat(o)))return;break;case"zoomStep":if(0>=parseFloat(o)||isNaN(parseFloat(o)))return}var n=t.ui.version.split(".");switch(n[0]>1||n[1]>8?this._super(e,o):t.Widget.prototype._setOption.apply(this,arguments),e){case"zoom":this.ready&&this.update()}},addElem:function(e){t(this.view).append(e)},isVisible:function(t,e){var o=this.getView();return o?t>=o.left&&o.right>=t&&e>=o.top&&o.bottom>=e:!1},getView:function(){if(this.ready){var e=t(this.img),o=e.width(),n=e.height(),i=this.options.zoom;return{top:this.vCenter.y/n-.5/i,left:this.vCenter.x/o-.5/i,bottom:this.vCenter.y/n+.5/i,right:this.vCenter.x/o+.5/i}}return null},panTo:function(e,o){if(this.ready&&e>=0&&1>=e&&o>=0&&1>=o){var n=t(this.img),i=n.width(),r=n.height();return this.vCenter.x=e*i,this.vCenter.y=o*r,this.update(),{x:this.vCenter.x/i,y:this.vCenter.y/r}}return null},imgToView:function(e,o){if(this.ready&&e>=0&&1>=e&&o>=0&&1>=o){var n=t(this.img),i=n.width(),r=n.height(),s=i/2-this.vCenter.x*this.options.zoom,a=r/2-this.vCenter.y*this.options.zoom,p=e*i*this.options.zoom+s,h=o*r*this.options.zoom+a;return{x:Math.round(p),y:Math.round(h)}}return null},imgToCursor:function(e,o){var n=this.imgToView(e,o);if(n){var i=t(this.img).offset();return n.x+=i.left+this.offsetBorder.x+this.offsetPadding.left,n.y+=i.top+this.offsetBorder.y+this.offsetPadding.top,n}return null},viewToImg:function(e,o){if(this.ready){var n=t(this.img),i=n.width(),r=n.height(),s=i/2-this.vCenter.x*this.options.zoom,a=r/2-this.vCenter.y*this.options.zoom,p=(e-s)/(i*this.options.zoom),h=(o-a)/(r*this.options.zoom);return p>=0&&1>=p&&h>=0&&1>=h?{x:p,y:h}:null}return null},cursorToImg:function(e,o){if(this.ready){var n=t(this.img),i=n.width(),r=n.height(),s=n.offset(),a=i/2-this.vCenter.x*this.options.zoom,p=r/2-this.vCenter.y*this.options.zoom,h=(e-s.left-this.offsetBorder.x-this.offsetPadding.left-a)/(i*this.options.zoom),d=(o-s.top-this.offsetBorder.y-this.offsetPadding.top-p)/(r*this.options.zoom);return h>=0&&1>=h&&d>=0&&1>=d?{x:h,y:d}:null}return null},update:function(){if(this.ready){var e,o,n,i,r=t(this.img),s=r.width(),a=r.height(),p=r.offset(),h=this.options.zoom,d=s/2,u=a/2;1>=h?(e=0,o=0,n=s,i=a,this.vCenter={x:d,y:u},this.options.zoom=1,h=1):(e=Math.round(u-this.vCenter.y*h),o=Math.round(d-this.vCenter.x*h),n=Math.round(s*h),i=Math.round(a*h),o>0?(this.vCenter.x=d/h,o=0):s>o+n&&(this.vCenter.x=s-d/h,o=s-n),e>0?(this.vCenter.y=u/h,e=0):a>e+i&&(this.vCenter.y=a-u/h,e=a-i));var f=Math.round(p.top+this.offsetBorder.y+this.offsetPadding.top),g=Math.round(p.left+this.offsetBorder.x+this.offsetPadding.left);t(this.view).css({top:f+"px",left:g+"px",width:s+"px",height:a+"px"}),t(this.zimg).css({width:s+"px",height:a+"px"});var l=-(this.vCenter.x-d)*h,m=-(this.vCenter.y-u)*h;t(this.zimg).css({transform:"translate("+l+"px,"+m+"px) scale("+h+","+h+")"}),this._trigger("onUpdate",null,this)}}})}(jQuery);