/*! jQuery imgViewer - v0.7.0 - 2014-06-19
* https://github.com/waynegm/imgViewer
* Copyright (c) 2014 Wayne Mogg; Licensed MIT */
(function(t,e){var o,i="drag",n={distance:40};e.track(i,{touchstart:function(t,e,n){o=!1,e[i]={finger:n.point.length,start:n,deltaX:0,deltaY:0}},touchmove:function(r,s,a){var h=t.extend(n,r.data);s[i].finger=a.point.length>s[i].finger?a.point.length:s[i].finger;var p=e.calc.getDistance(s.start.point[0],a.point[0]);Math.abs(1-p)>h.distance&&(o||(t(r.target).trigger(t.Event("dragstart",s[i])),o=!0),s[i].deltaX=a.point[0].x-s.start.point[0].x,s[i].deltaY=a.point[0].y-s.start.point[0].y,t(r.target).trigger(t.Event("drag",s[i])))},touchend:function(r,s,a){if(o){o=!1;var h=e.calc.getDistance(s.start.point[0],a.point[0]);h>n.distance&&(s[i].deltaX=a.point[0].x-s.start.point[0].x,s[i].deltaY=a.point[0].y-s.start.point[0].y,t(r.target).trigger(t.Event("dragend",s[i])))}}})})(jQuery,jQuery.toe,this),function(t){t.widget("wgm.imgViewer",{options:{zoomStep:.1,zoom:1,zoomable:!0,onClick:null,onUpdate:null},_create:function(){function e(){r.render||(r.render=!0,i())}function o(){r.render=!1}function i(){r.render&&(window.requestAnimationFrame(i),r.update())}function n(t){if(r.options.zoomable){t.preventDefault();var e=t.originalEvent,o=Math.max(-1,Math.min(1,e.wheelDelta||-e.detail));r.options.zoom-=o*r.options.zoomStep,r.update()}}var r=this;this.element.is("img")||t.error("imgviewer plugin can only be applied to img elements"),r.img=r.element[0];var s=t(r.img);r.zimg=t("<img/>",{src:r.img.src}).appendTo("body").wrap("<div class='viewport'/>");var a=t(r.zimg);r.view=t(r.zimg).parent();var h=t(r.view);r.vCenter={},r.dragging=!1,r.ready=!1,s.one("load",function(){r.ready=!0;var t=s.width(),e=s.height(),o=s.offset();r.offsetPadding={top:parseInt(s.css("padding-top"),10),left:parseInt(s.css("padding-left"),10),right:parseInt(s.css("padding-right"),10),bottom:parseInt(s.css("padding-bottom"),10)},r.offsetBorder={x:Math.round((s.outerWidth()-s.innerWidth())/2),y:Math.round((s.outerHeight()-s.innerHeight())/2)};var i=o.top+r.offsetBorder.y+r.offsetPadding.top,n=o.left+r.offsetBorder.x+r.offsetPadding.left;h.css({position:"absolute",overflow:"hidden",top:i+"px",left:n+"px",width:t+"px",height:e+"px"}),a.css({position:"relative",top:"0px",left:"0px",width:t+"px",height:e+"px","-webkit-tap-highlight-color":"transparent"}),r.vCenter={x:t/2,y:e/2},r.update()}).each(function(){this.complete&&t(this).load()}),r.render=!1,a.on("touchstart touchmove touchend",function(t){t.preventDefault()}),a.on("tap",function(t){r.dragging||(t.preventDefault(),r._trigger("onClick",t,r))}),a.on("transformstart",function(t){r.options.zoomable&&(t.preventDefault(),r.pinchzoom=r.options.zoom,e())}),a.on("transform",function(t){r.options.zoomable&&(t.preventDefault(),r.options.zoom=r.pinchzoom*t.scale)}),a.on("transformend",function(t){r.options.zoomable&&(t.preventDefault(),r.options.zoom=r.pinchzoom*t.scale,o())}),a.on("dragstart",function(t){r.options.zoomable&&(t.preventDefault(),r.dragging=!0,r.dragXorg=r.vCenter.x,r.dragYorg=r.vCenter.y,e())}),a.on("drag",function(t){r.options.zoomable&&(t.preventDefault(),r.vCenter.x=r.dragXorg-t.deltaX/r.options.zoom,r.vCenter.y=r.dragYorg-t.deltaY/r.options.zoom)}),a.on("dragend",function(t){r.options.zoomable&&(t.preventDefault(),r.dragging=!1,r.vCenter.x=r.dragXorg-t.deltaX/r.options.zoom,r.vCenter.y=r.dragYorg-t.deltaY/r.options.zoom,o())}),a.on("mousewheel",n),a.on("DOMMouseScroll",n),a.on("onmousewheel",n),a.click(function(t){r.dragging||r._trigger("onClick",t,r)}),a.mousedown(function(i){function n(e){e.preventDefault(),o(),setTimeout(function(){r.dragging=!1},0),a.unbind("mousemove"),a.unbind("mouseup"),t(document).unbind("mouseup")}if(r.options.zoomable){i.preventDefault(),e();var s=i;a.mousemove(function(t){t.preventDefault(),r.dragging=!0,r.vCenter.x=r.vCenter.x-(t.pageX-s.pageX)/r.options.zoom,r.vCenter.y=r.vCenter.y-(t.pageY-s.pageY)/r.options.zoom,s=t}),t(document).one("mouseup",n),a.one("mouseup",n)}}),t(window).resize(function(){r.ready&&(r.vCenter.x*=s.width()/h.width(),r.vCenter.y*=s.height()/h.height(),r.update())})},destroy:function(){var e=t(this.zimg);e.unbind("click"),t(window).unbind("resize"),e.remove(),t(this.view).remove(),t.Widget.prototype.destroy.call(this)},_setOption:function(e,o){switch(e){case"zoom":if(1>parseFloat(o)||isNaN(parseFloat(o)))return;break;case"zoomStep":if(0>=parseFloat(o)||isNaN(parseFloat(o)))return}var i=t.ui.version.split(".");switch(i[0]>1||i[1]>8?this._super(e,o):t.Widget.prototype._setOption.apply(this,arguments),e){case"zoom":this.ready&&this.update()}},addElem:function(e){t(this.view).append(e)},isVisible:function(t,e){var o=this.getView();return o?t>=o.left&&o.right>=t&&e>=o.top&&o.bottom>=e:!1},getView:function(){if(this.ready){var e=t(this.img),o=e.width(),i=e.height(),n=this.options.zoom;return{top:this.vCenter.y/i-.5/n,left:this.vCenter.x/o-.5/n,bottom:this.vCenter.y/i+.5/n,right:this.vCenter.x/o+.5/n}}return null},panTo:function(e,o){if(this.ready&&e>=0&&1>=e&&o>=0&&1>=o){var i=t(this.img),n=i.width(),r=i.height();return this.vCenter.x=e*n,this.vCenter.y=o*r,this.update(),{x:this.vCenter.x/n,y:this.vCenter.y/r}}return null},imgToView:function(e,o){if(this.ready&&e>=0&&1>=e&&o>=0&&1>=o){var i=t(this.img),n=i.width(),r=i.height(),s=n/2-this.vCenter.x*this.options.zoom,a=r/2-this.vCenter.y*this.options.zoom,h=e*n*this.options.zoom+s,p=o*r*this.options.zoom+a;return{x:Math.round(h),y:Math.round(p)}}return null},imgToCursor:function(e,o){var i=this.imgToView(e,o);if(i){var n=t(this.img).offset();return i.x+=n.left+this.offsetBorder.x+this.offsetPadding.left,i.y+=n.top+this.offsetBorder.y+this.offsetPadding.top,i}return null},viewToImg:function(e,o){if(this.ready){var i=t(this.img),n=i.width(),r=i.height(),s=n/2-this.vCenter.x*this.options.zoom,a=r/2-this.vCenter.y*this.options.zoom,h=(e-s)/(n*this.options.zoom),p=(o-a)/(r*this.options.zoom);return h>=0&&1>=h&&p>=0&&1>=p?{x:h,y:p}:null}return null},cursorToImg:function(e,o){if(this.ready){var i=t(this.img),n=i.width(),r=i.height(),s=i.offset(),a=n/2-this.vCenter.x*this.options.zoom,h=r/2-this.vCenter.y*this.options.zoom,p=(e-s.left-this.offsetBorder.x-this.offsetPadding.left-a)/(n*this.options.zoom),d=(o-s.top-this.offsetBorder.y-this.offsetPadding.top-h)/(r*this.options.zoom);return p>=0&&1>=p&&d>=0&&1>=d?{x:p,y:d}:null}return null},update:function(){if(this.ready){var e,o,i,n,r=t(this.img),s=r.width(),a=r.height(),h=r.offset(),p=this.options.zoom,d=s/2,g=a/2;1>=p?(e=0,o=0,i=s,n=a,this.vCenter={x:d,y:g},this.options.zoom=1,p=1):(e=Math.round(g-this.vCenter.y*p),o=Math.round(d-this.vCenter.x*p),i=Math.round(s*p),n=Math.round(a*p),o>0?(this.vCenter.x=d/p,o=0):s>o+i&&(this.vCenter.x=s-d/p,o=s-i),e>0?(this.vCenter.y=g/p,e=0):a>e+n&&(this.vCenter.y=a-g/p,e=a-n));var u=Math.round(h.top+this.offsetBorder.y+this.offsetPadding.top),f=Math.round(h.left+this.offsetBorder.x+this.offsetPadding.left);t(this.view).css({top:u+"px",left:f+"px",width:s+"px",height:a+"px"}),t(this.zimg).css({width:s+"px",height:a+"px"});var l=-(this.vCenter.x-d)*p,m=-(this.vCenter.y-g)*p;t(this.zimg).css({transform:"translate("+l+"px,"+m+"px) scale("+p+","+p+")"}),this._trigger("onUpdate",null,this)}}})}(jQuery);